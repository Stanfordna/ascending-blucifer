# =============================================================================
# Maggie Chamberlain Dietitian Website - Docker Compose
# Development environment with hot reload
# =============================================================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: maggie-dietitian-app
    ports:
      - "8080:80"      # Laravel/Nginx
      - "5173:5173"    # Vite dev server
    volumes:
      # Mount application code for live updates
      - .:/var/www/html
      # Persist vendor directory for performance
      - vendor:/var/www/html/vendor
      # Persist node_modules for performance
      - node_modules:/var/www/html/node_modules
      # Persist SQLite database
      - ./database/database.sqlite:/var/www/html/database/database.sqlite
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - APP_URL=http://localhost:8080
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/html/database/database.sqlite
      - VITE_DEV_SERVER_URL=http://localhost:5173
    networks:
      - maggie-network
    working_dir: /var/www/html
    # Run composer install and npm install on startup if needed
    entrypoint: >
      sh -c "
        if [ ! -d vendor ]; then composer install; fi &&
        if [ ! -d node_modules ]; then npm install; fi &&
        chown -R www:www storage bootstrap/cache &&
        /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
      "

  # Optional: Run Vite dev server separately for HMR
  vite:
    image: node:20-alpine
    container_name: maggie-dietitian-vite
    working_dir: /app
    ports:
      - "5174:5173"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    networks:
      - maggie-network
    profiles:
      - dev

networks:
  maggie-network:
    driver: bridge

volumes:
  vendor:
  node_modules:
